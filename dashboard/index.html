<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üß† Hippocampus ‚Äî Workspace Memory Dashboard</title>
<style>
  :root {
    --bg: #0d1117; --surface: #161b22; --border: #30363d; --text: #e6edf3;
    --muted: #8b949e; --accent: #58a6ff; --green: #3fb950; --yellow: #d29922;
    --red: #f85149; --purple: #bc8cff;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'SF Mono', 'Fira Code', monospace; background: var(--bg); color: var(--text); }
  
  .layout { display: grid; grid-template-columns: 280px 1fr; grid-template-rows: auto 1fr; height: 100vh; }
  
  /* Header */
  .header { grid-column: 1 / -1; padding: 12px 20px; background: var(--surface);
    border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 16px; }
  .header h1 { font-size: 16px; font-weight: 600; }
  .header h1 span { font-size: 20px; }
  .budget-bar { flex: 1; max-width: 300px; }
  .budget-bar .bar { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
  .budget-bar .fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
  .budget-label { font-size: 11px; color: var(--muted); margin-top: 2px; }
  .badges { display: flex; gap: 8px; margin-left: auto; }
  .badge { font-size: 11px; padding: 2px 8px; border-radius: 10px; }
  .badge.ok { background: #1a3a2a; color: var(--green); }
  .badge.warn { background: #3a2a1a; color: var(--yellow); }
  .badge.critical { background: #3a1a1a; color: var(--red); }
  
  /* Sidebar */
  .sidebar { background: var(--surface); border-right: 1px solid var(--border);
    overflow-y: auto; padding: 8px 0; }
  .sidebar-section { padding: 8px 16px; font-size: 11px; color: var(--muted);
    text-transform: uppercase; letter-spacing: 0.5px; }
  .file-item { padding: 6px 16px; cursor: pointer; display: flex; justify-content: space-between;
    align-items: center; font-size: 13px; border-left: 2px solid transparent; }
  .file-item:hover { background: rgba(88,166,255,0.08); }
  .file-item.active { background: rgba(88,166,255,0.12); border-left-color: var(--accent); }
  .file-item .name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .file-item .meta { font-size: 11px; color: var(--muted); white-space: nowrap; margin-left: 8px; }
  .file-item .meta.over { color: var(--red); font-weight: 600; }
  
  /* Main area */
  .main { display: flex; flex-direction: column; overflow: hidden; }
  
  /* Tabs */
  .tabs { display: flex; background: var(--surface); border-bottom: 1px solid var(--border); }
  .tab { padding: 8px 16px; font-size: 12px; cursor: pointer; color: var(--muted);
    border-bottom: 2px solid transparent; }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  
  /* Editor */
  .editor-wrap { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
  .editor { flex: 1; width: 100%; background: var(--bg); color: var(--text); border: none;
    padding: 16px 20px; font-family: inherit; font-size: 13px; line-height: 1.6;
    resize: none; outline: none; tab-size: 2; }
  .editor-footer { padding: 6px 16px; background: var(--surface); border-top: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center; font-size: 11px; color: var(--muted); }
  .save-btn { background: var(--accent); color: #000; border: none; padding: 4px 12px;
    border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600; }
  .save-btn:hover { opacity: 0.9; }
  .save-btn:disabled { opacity: 0.4; cursor: default; }
  .save-status { color: var(--green); }
  
  /* History */
  .history-panel { flex: 1; overflow-y: auto; padding: 12px 20px; display: none; }
  .history-panel.active { display: block; }
  .commit { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px;
    margin-bottom: 8px; cursor: pointer; }
  .commit:hover { border-color: var(--accent); }
  .commit.selected { border-color: var(--accent); background: rgba(88,166,255,0.08); }
  .commit-hash { font-size: 11px; color: var(--purple); }
  .commit-date { font-size: 11px; color: var(--muted); margin-left: 8px; }
  .commit-msg { font-size: 12px; margin-top: 4px; }
  
  /* Diff */
  .diff-panel { flex: 1; overflow-y: auto; padding: 12px 20px; display: none; font-size: 12px; }
  .diff-panel.active { display: block; }
  .diff-line { padding: 1px 8px; white-space: pre-wrap; word-break: break-all; }
  .diff-add { background: rgba(63,185,80,0.15); color: var(--green); }
  .diff-del { background: rgba(248,81,73,0.15); color: var(--red); }
  .diff-hunk { color: var(--purple); margin-top: 8px; }
  
  /* Validators */
  .validators { padding: 12px 20px; display: none; overflow-y: auto; flex: 1; }
  .validators.active { display: block; }
  .issue { padding: 8px 12px; border-radius: 6px; margin-bottom: 6px; font-size: 12px;
    display: flex; align-items: center; gap: 8px; }
  .issue.warn { background: rgba(210,153,34,0.1); border: 1px solid rgba(210,153,34,0.3); }
  .issue.critical { background: rgba(248,81,73,0.1); border: 1px solid rgba(248,81,73,0.3); }
  .issue-icon { font-size: 14px; }
  .no-issues { color: var(--green); font-size: 13px; padding: 20px; }

  /* Welcome */
  .welcome { flex: 1; display: flex; align-items: center; justify-content: center;
    flex-direction: column; color: var(--muted); gap: 8px; }
  .welcome .big { font-size: 48px; }
</style>
</head>
<body>

<div class="layout">
  <div class="header">
    <h1><span>üß†</span> Hippocampus</h1>
    <div class="budget-bar">
      <div class="bar"><div class="fill" id="budgetFill"></div></div>
      <div class="budget-label" id="budgetLabel">Loading...</div>
    </div>
    <div class="badges" id="badges"></div>
  </div>

  <div class="sidebar" id="sidebar"></div>

  <div class="main" id="main">
    <div class="welcome"><div class="big">üß†</div><div>Select a file to view or edit</div></div>
  </div>
</div>

<script>
const API = '';
let currentFile = null;
let dirty = false;
let allFiles = [];

async function api(path) {
  const r = await fetch(API + path);
  return r.json();
}

function formatSize(b) {
  return b < 1024 ? b + 'B' : (b/1024).toFixed(1) + 'KB';
}

async function loadSidebar() {
  allFiles = await api('/api/files');
  const budget = await api('/api/budget');
  
  // Budget bar
  const pct = Math.min(100, (budget.bootstrapTotal / budget.limit) * 100);
  const fill = document.getElementById('budgetFill');
  fill.style.width = pct + '%';
  fill.style.background = pct > 80 ? 'var(--red)' : pct > 60 ? 'var(--yellow)' : 'var(--green)';
  document.getElementById('budgetLabel').textContent =
    `${formatSize(budget.bootstrapTotal)} / ${formatSize(budget.limit)} (~${budget.bootstrapTokens} tokens)`;

  // Validators
  const v = await api('/api/validate');
  const badges = document.getElementById('badges');
  if (v.issues.length === 0) {
    badges.innerHTML = '<span class="badge ok">‚úì All checks pass</span>';
  } else {
    badges.innerHTML = v.issues.map(i =>
      `<span class="badge ${i.level}">${i.level === 'critical' ? 'üî¥' : '‚ö†Ô∏è'} ${i.file}: ${i.msg}</span>`
    ).join('');
  }

  // File list
  const sb = document.getElementById('sidebar');
  const bootstrap = ['HIPPOCAMPUS.md','AGENTS.md','SOUL.md','MEMORY.md','USER.md','IDENTITY.md','TOOLS.md','HEARTBEAT.md'];
  const bootstrapFiles = budget.files || [];
  const memoryFiles = allFiles.filter(f => f.path.startsWith('memory/')).sort((a,b) => b.path.localeCompare(a.path));
  const docFiles = allFiles.filter(f => f.path.startsWith('docs/')).sort();
  const otherFiles = allFiles.filter(f =>
    !bootstrap.includes(f.path) && !f.path.startsWith('memory/') && !f.path.startsWith('docs/')
    && !f.path.startsWith('skills/') && !f.path.startsWith('tools/')
  ).sort();

  let html = '<div class="sidebar-section">üß† Bootstrap (loaded every turn)</div>';
  for (const name of bootstrap) {
    const f = bootstrapFiles.find(b => b.path === name) || allFiles.find(b => b.path === name);
    if (!f) continue;
    const limit = f.limit;
    const over = limit && f.size > limit;
    html += `<div class="file-item ${currentFile === name ? 'active' : ''}" onclick="openFile('${name}')">
      <span class="name">${name}</span>
      <span class="meta ${over ? 'over' : ''}">${formatSize(f.size)}${limit ? '/' + formatSize(limit) : ''}</span>
    </div>`;
  }

  html += '<div class="sidebar-section">üìù Daily Memory</div>';
  for (const f of memoryFiles) {
    html += `<div class="file-item ${currentFile === f.path ? 'active' : ''}" onclick="openFile('${f.path}')">
      <span class="name">${f.path.replace('memory/', '')}</span>
      <span class="meta">${formatSize(f.size)}</span>
    </div>`;
  }

  html += '<div class="sidebar-section">üìö Docs (archived)</div>';
  for (const f of docFiles) {
    html += `<div class="file-item ${currentFile === f.path ? 'active' : ''}" onclick="openFile('${f.path}')">
      <span class="name">${f.path.replace('docs/', '')}</span>
      <span class="meta">${formatSize(f.size)}</span>
    </div>`;
  }

  if (otherFiles.length) {
    html += '<div class="sidebar-section">üìÑ Other</div>';
    for (const f of otherFiles) {
      html += `<div class="file-item ${currentFile === f.path ? 'active' : ''}" onclick="openFile('${f.path}')">
        <span class="name">${f.path}</span>
        <span class="meta">${formatSize(f.size)}</span>
      </div>`;
    }
  }

  sb.innerHTML = html;
}

async function openFile(filePath) {
  if (dirty && !confirm('Unsaved changes. Discard?')) return;
  currentFile = filePath;
  dirty = false;

  const { content } = await api('/api/file/' + encodeURIComponent(filePath));
  const history = await api('/api/git/log/' + encodeURIComponent(filePath));

  const main = document.getElementById('main');
  main.innerHTML = `
    <div class="tabs">
      <div class="tab active" onclick="switchTab('editor')">‚úèÔ∏è Edit</div>
      <div class="tab" onclick="switchTab('history')">üìú History (${history.length})</div>
      <div class="tab" onclick="switchTab('validators')">üîç Validate</div>
    </div>
    <div class="editor-wrap" id="panel-editor">
      <textarea class="editor" id="editor" spellcheck="false">${escHtml(content)}</textarea>
      <div class="editor-footer">
        <span id="editorMeta">${filePath} ‚Äî ${formatSize(new Blob([content]).size)} ‚Äî ~${Math.round(content.length/4)} tokens</span>
        <span>
          <span id="saveStatus"></span>
          <button class="save-btn" id="saveBtn" disabled onclick="saveFile()">Save</button>
        </span>
      </div>
    </div>
    <div class="history-panel" id="panel-history">
      ${history.length ? history.map(h => `
        <div class="commit" onclick="showDiff('${h.hash}', '${filePath}', this)">
          <span class="commit-hash">${h.hash.slice(0,8)}</span>
          <span class="commit-date">${h.date}</span>
          <div class="commit-msg">${escHtml(h.message)}</div>
        </div>
      `).join('') : '<div style="color:var(--muted);padding:20px;">No git history for this file.</div>'}
      <div id="diffView"></div>
    </div>
    <div class="validators" id="panel-validators"></div>
  `;

  document.getElementById('editor').addEventListener('input', () => {
    dirty = true;
    document.getElementById('saveBtn').disabled = false;
    document.getElementById('saveStatus').textContent = '';
    updateEditorMeta();
  });

  loadValidators();
  loadSidebar();
}

function updateEditorMeta() {
  const ed = document.getElementById('editor');
  if (!ed) return;
  const size = new Blob([ed.value]).size;
  document.getElementById('editorMeta').textContent =
    `${currentFile} ‚Äî ${formatSize(size)} ‚Äî ~${Math.round(ed.value.length/4)} tokens`;
}

async function saveFile() {
  const content = document.getElementById('editor').value;
  const r = await fetch(API + '/api/file/' + encodeURIComponent(currentFile), {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ content })
  });
  const data = await r.json();
  if (data.ok) {
    dirty = false;
    document.getElementById('saveBtn').disabled = true;
    document.getElementById('saveStatus').innerHTML = '<span class="save-status">‚úì Saved</span>';
    loadSidebar();
  }
}

async function showDiff(hash, filePath, el) {
  document.querySelectorAll('.commit').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  const { diff } = await api(`/api/git/diff/${hash}/${encodeURIComponent(filePath)}`);
  const diffView = document.getElementById('diffView');
  const lines = diff.split('\n').map(l => {
    if (l.startsWith('@@')) return `<div class="diff-line diff-hunk">${escHtml(l)}</div>`;
    if (l.startsWith('+') && !l.startsWith('+++')) return `<div class="diff-line diff-add">${escHtml(l)}</div>`;
    if (l.startsWith('-') && !l.startsWith('---')) return `<div class="diff-line diff-del">${escHtml(l)}</div>`;
    return `<div class="diff-line">${escHtml(l)}</div>`;
  });
  diffView.innerHTML = lines.join('');
}

async function loadValidators() {
  const v = await api('/api/validate');
  const panel = document.getElementById('panel-validators');
  if (!panel) return;
  if (v.issues.length === 0) {
    panel.innerHTML = '<div class="no-issues">‚úÖ All validation checks pass</div>';
  } else {
    panel.innerHTML = v.issues.map(i => `
      <div class="issue ${i.level}">
        <span class="issue-icon">${i.level === 'critical' ? 'üî¥' : '‚ö†Ô∏è'}</span>
        <strong>${i.file}</strong>: ${i.msg}
      </div>
    `).join('');
  }
}

function switchTab(name) {
  document.querySelectorAll('.tab').forEach((t, i) => {
    t.classList.toggle('active', t.textContent.includes(
      name === 'editor' ? 'Edit' : name === 'history' ? 'History' : 'Validate'
    ));
  });
  ['editor', 'history', 'validators'].forEach(p => {
    const el = document.getElementById('panel-' + p);
    if (el) el.classList.toggle('active', p === name);
    if (el && p === 'editor') el.style.display = p === name ? 'flex' : 'none';
  });
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// Keyboard shortcut
document.addEventListener('keydown', e => {
  if ((e.metaKey || e.ctrlKey) && e.key === 's') {
    e.preventDefault();
    if (dirty) saveFile();
  }
});

loadSidebar();
</script>
</body>
</html>
